<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMT 69 - Control Entrada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
        .navbar {
            background: #000 !important;
            border-bottom: 2px solid #00ff00;
        }
        .card {
            background: #2d2d2d;
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        .nav-tabs .nav-link {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        .nav-tabs .nav-link.active {
            background: #00ff00;
            color: #000;
            font-weight: bold;
        }
        .btn-success {
            background: #00ff00;
            border-color: #00ff00;
            color: #000;
            font-weight: bold;
        }
        .btn-primary {
            background: #0066ff;
            border-color: #0066ff;
        }
        .form-control {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        .form-control:focus {
            background: #1a1a1a;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            color: #00ff00;
        }
        .table-dark {
            --bs-table-bg: #2d2d2d;
        }
        .alert-success {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
            color: #00ff00;
        }
        .alert-danger {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ff0000;
            color: #ff0000;
        }
        #reader {
            border: 2px solid #00ff00;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">DMT 69 - CONTROL ENTRADA</span>
            <div>
                <span class="text-light me-3">{{ user.username }} ({{ user.perfilusuario.get_rol_display }})</span>
                <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">LOGOUT</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Stats Row -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2>{{ stats.total_asistentes }}</h2>
                        <small>REGISTRADOS</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2>{{ stats.asistentes_ingresados }}</h2>
                        <small>INGRESARON</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2>{{ stats.pendientes }}</h2>
                        <small>PENDIENTES</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2>{{ stats.mis_verificaciones }}</h2>
                        <small>MIS VERIFICACIONES</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="scanner-tab" data-bs-toggle="tab" data-bs-target="#scanner" type="button">
                            <i class="fas fa-qrcode"></i> SCANNER QR
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista" type="button">
                            <i class="fas fa-list"></i> LISTA ASISTENTES
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="crear-tab" data-bs-toggle="tab" data-bs-target="#crear" type="button">
                            <i class="fas fa-plus"></i> NUEVO ASISTENTE
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="buscar-tab" data-bs-toggle="tab" data-bs-target="#buscar" type="button">
                            <i class="fas fa-search"></i> BUSCAR CC
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="mainTabsContent">
                    
                    <!-- TAB 1: SCANNER QR -->
                    <div class="tab-pane fade show active" id="scanner" role="tabpanel">
                        <div class="text-center">
                            <h4 class="mb-4">VERIFICACIÓN DE ENTRADA</h4>
                            <div id="reader" style="width: 100%; max-width: 400px; margin: 0 auto; height: 300px;"></div>
                            <div class="mt-3">
                                <button id="start-btn" class="btn btn-success btn-lg me-2">
                                    <i class="fas fa-play"></i> INICIAR SCANNER
                                </button>
                                <button id="stop-btn" class="btn btn-danger btn-lg" style="display:none;">
                                    <i class="fas fa-stop"></i> DETENER
                                </button>
                            </div>
                            <div id="scan-result" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- TAB 2: LISTA ASISTENTES -->
                    <div class="tab-pane fade" id="lista" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" id="filtro-buscar" class="form-control" placeholder="Buscar por nombre o cédula...">
                            </div>
                            <div class="col-md-3">
                                <select id="filtro-estado" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="ingresados">Ingresaron</option>
                                    <option value="pendientes">Pendientes</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary" onclick="cargarLista()">
                                    <i class="fas fa-sync"></i> ACTUALIZAR
                                </button>
                            </div>
                        </div>
                        <div id="lista-asistentes">
                            <div class="text-center">
                                <button class="btn btn-success" onclick="cargarLista()">
                                    <i class="fas fa-download"></i> CARGAR LISTA COMPLETA
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: NUEVO ASISTENTE -->
                    <div class="tab-pane fade" id="crear" role="tabpanel">
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <h4 class="text-center mb-4">REGISTRAR NUEVO ASISTENTE</h4>
                                
                                {% if messages %}
                                    {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                                    {% endfor %}
                                {% endif %}
                                
                                <form method="POST" action="{% url 'core:crear_asistente' %}" id="form-crear">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label class="form-label">NOMBRE COMPLETO:</label>
                                        <input type="text" name="nombre" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">CÉDULA:</label>
                                        <input type="text" name="cc" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">TELÉFONO:</label>
                                        <input type="text" name="numero" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">CORREO:</label>
                                        <input type="email" name="correo" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">CATEGORÍA:</label>
                                        <select name="categoria" class="form-control" required>
                                            <option value="">Seleccionar...</option>
                                            {% for categoria in categorias %}
                                            <option value="{{ categoria.pk }}">
                                                {{ categoria.nombre }} - {{ categoria.consumos_incluidos }} consumos
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100 btn-lg">
                                        <i class="fas fa-save"></i> CREAR ASISTENTE
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 4: BUSCAR POR CC -->
                    <div class="tab-pane fade" id="buscar" role="tabpanel">
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <h4 class="text-center mb-4">BUSCAR POR CÉDULA</h4>
                                <div class="input-group mb-3">
                                    <input type="text" id="buscar-cc" class="form-control" placeholder="Número de cédula">
                                    <button class="btn btn-primary" onclick="buscarPorCC()">
                                        <i class="fas fa-search"></i> BUSCAR
                                    </button>
                                </div>
                                <div id="resultado-cc"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: #000; border: 2px solid #00ff00;">
                <div class="modal-header" style="border-color: #00ff00;">
                    <h5 class="modal-title text-success">
                        <i class="fas fa-check-circle"></i> ACCESO AUTORIZADO
                    </h5>
                </div>
                <div class="modal-body text-success" id="modal-content"></div>
                <div class="modal-footer" style="border-color: #00ff00;">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">CONTINUAR</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        let html5QrCode = null;
        let isScanning = false;

        // ===== SCANNER QR =====

        document.getElementById('start-btn').onclick = function() {
            html5QrCode = new Html5Qrcode("reader");
            
            // --- INICIO DE LA MODIFICACIÓN ---
            // Configuración para el escáner (tamaño, fps)
            const scannerConfig = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 } 
            };

            // Configuración para la cámara: Pide la cámara trasera ("environment")
            const cameraConfig = { facingMode: "environment" };

            html5QrCode.start(
                cameraConfig,   // <-- Usamos la configuración de la cámara trasera
                scannerConfig,  // <-- Usamos la configuración del escáner
                onScanSuccess,
                (errorMessage) => {
                    // Manejar errores de escaneo si es necesario
                }
            ).catch((err) => {
                // Si falla al intentar usar la cámara trasera (en algunos dispositivos)
                // intentará usar cualquier cámara disponible como plan B.
                console.warn("No se pudo iniciar la cámara trasera, intentando con la cámara por defecto.", err);
                html5QrCode.start(
                    { facingMode: "user" }, // Intenta la frontal si la trasera falló
                    scannerConfig,
                    onScanSuccess
                );
            });
            // --- FIN DE LA MODIFICACIÓN ---

            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
            isScanning = true;
            
            document.getElementById('scan-result').innerHTML = 
                '<div class="alert alert-success">Scanner activo - Posicione el QR frente a la cámara</div>';
        };
            document.getElementById('stop-btn').onclick = function() {
                if (html5QrCode && isScanning) {
                    html5QrCode.stop();
                    document.getElementById('start-btn').style.display = 'inline-block';
                    document.getElementById('stop-btn').style.display = 'none';
                    isScanning = false;
                    document.getElementById('scan-result').innerHTML = '';
                }
            };

        function onScanSuccess(decodedText) {
            if (!isScanning) return;
            isScanning = false;
            
            document.getElementById('scan-result').innerHTML = 
                '<div class="alert alert-info">Verificando QR...</div>';
            
            fetch('{% url "core:verificar_qr" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ codigo: decodedText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const a = data.asistente;
                    document.getElementById('modal-content').innerHTML = `
                        <div class="text-center">
                            <h2 class="text-success mb-3">${a.nombre}</h2>
                            <div class="row">
                                <div class="col-6"><strong>CÉDULA:</strong></div>
                                <div class="col-6">${a.cc}</div>
                            </div>
                            <div class="row">
                                <div class="col-6"><strong>CATEGORÍA:</strong></div>
                                <div class="col-6">${a.categoria}</div>
                            </div>
                            <div class="row">
                                <div class="col-6"><strong>CONSUMOS:</strong></div>
                                <div class="col-6">${a.consumos}</div>
                            </div>
                            <div class="row">
                                <div class="col-6"><strong>HORA INGRESO:</strong></div>
                                <div class="col-6">${a.hora}</div>
                            </div>
                        </div>
                    `;
                    new bootstrap.Modal(document.getElementById('confirmModal')).show();
                    
                    // Actualizar stats
                    setTimeout(() => location.reload(), 2000);
                } else {
                    document.getElementById('scan-result').innerHTML = 
                        '<div class="alert alert-danger">' + data.message + '</div>';
                }
                
                setTimeout(() => { isScanning = true; }, 3000);
            })
            .catch(error => {
                document.getElementById('scan-result').innerHTML = 
                    '<div class="alert alert-danger">Error de conexión</div>';
                setTimeout(() => { isScanning = true; }, 3000);
            });
        }

        // ===== CARGAR LISTA =====
        function cargarLista() {
            const buscar = document.getElementById('filtro-buscar').value;
            const estado = document.getElementById('filtro-estado').value;
            
            let url = '{% url "core:lista_asistentes" %}';
            let params = new URLSearchParams();
            if (buscar) params.append('buscar', buscar);
            if (estado) params.append('estado', estado);
            if (params.toString()) url += '?' + params.toString();
            
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('lista-asistentes').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('lista-asistentes').innerHTML = 
                    '<div class="alert alert-danger">Error cargando lista</div>';
            });
        }

        // ===== MARCAR INGRESO =====
        function marcarIngreso(cc) {
            if (!confirm('¿Marcar este asistente como ingresado?')) return;
            
            fetch('{% url "core:marcar_ingreso" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ cc: cc })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    cargarLista(); // Recargar lista
                    // Actualizar stats
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }

        // ===== ELIMINAR ASISTENTE =====
        function eliminarAsistente(cc) {
            if (!confirm('¿ELIMINAR este asistente permanentemente?')) return;
            
            fetch('{% url "core:eliminar_asistente" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ cc: cc })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    cargarLista(); // Recargar lista
                    location.reload(); // Actualizar stats
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }

        // ===== VER QR =====
        function verQR(cc) {
            fetch(`{% url "core:obtener_qr" "PLACEHOLDER" %}`.replace('PLACEHOLDER', cc))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modalBody = `
                        <div class="text-center">
                            <h4>${data.asistente.nombre}</h4>
                            <p><strong>CC:</strong> ${data.asistente.cc}</p>
                            <p><strong>Categoría:</strong> ${data.asistente.categoria}</p>
                            <p><strong>Consumos:</strong> ${data.asistente.consumos}</p>
                            <div class="my-3">
                                <img src="${data.qr_url}" alt="QR Code" style="max-width: 250px;" class="img-fluid">
                            </div>
                            <a href="${data.qr_url}" download="qr_${data.asistente.cc}.png" class="btn btn-primary btn-sm">
                                <i class="fas fa-download"></i> DESCARGAR QR
                            </a>
                        </div>
                    `;
                    
                    document.getElementById('modal-content').innerHTML = modalBody;
                    document.querySelector('#confirmModal .modal-title').innerHTML = 
                        '<i class="fas fa-qrcode"></i> CÓDIGO QR';
                    new bootstrap.Modal(document.getElementById('confirmModal')).show();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }

        // ===== EDITAR ASISTENTE =====
        function editarAsistente(cc) {
            window.open(`/asistentes/${cc}/editar/`, '_blank');
        }

        // ===== BUSCAR POR CC =====
        function buscarPorCC() {
            const cc = document.getElementById('buscar-cc').value.trim();
            if (!cc) return;
            
            fetch(`{% url "core:buscar_asistente" %}?cc=${cc}`)
            .then(response => response.json())
            .then(data => {
                const resultado = document.getElementById('resultado-cc');
                if (data.success) {
                    const a = data.asistente;
                    resultado.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5>${a.nombre}</h5>
                                <p><strong>CC:</strong> ${a.cc}</p>
                                <p><strong>Categoría:</strong> ${a.categoria}</p>
                                <p><strong>Estado:</strong> 
                                    <span class="badge ${a.ha_ingresado ? 'bg-success' : 'bg-warning'}">
                                        ${a.ha_ingresado ? 'INGRESÓ' : 'PENDIENTE'}
                                    </span>
                                </p>
                                ${a.fecha_ingreso ? '<p><strong>Fecha ingreso:</strong> ' + a.fecha_ingreso + '</p>' : ''}
                                <p><strong>Consumos disponibles:</strong> ${a.consumos}</p>
                                <div class="mt-3">
                                    <a href="/asistentes/${a.cc}/qr/" class="btn btn-info btn-sm">VER QR</a>
                                    <a href="/asistentes/${a.cc}/editar/" class="btn btn-warning btn-sm">EDITAR</a>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultado.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
                }
            });
        }

        // Auto-reload stats cada 30 segundos
        setInterval(() => {
            if (!isScanning) {
                // Solo recargar los números de stats sin recargar toda la página
                fetch('{% url "core:dashboard" %}')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const statsCards = doc.querySelectorAll('.card h2');
                    const currentCards = document.querySelectorAll('.card h2');
                    
                    statsCards.forEach((card, index) => {
                        if (currentCards[index]) {
                            currentCards[index].textContent = card.textContent;
                        }
                    });
                });
            }
        }, 30000);
    </script>
</body>
</html>